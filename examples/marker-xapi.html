<!DOCTYPE html>
<html manifest="../map.manifest">
	<head>
		<meta charset="utf-8">
		<title>Slippy Map on Canvas (HTML5) | osm xapi | node[amenity=arts_centre]</title>
		<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<link rel="apple-touch-icon-precomposed" href="../images/touch-icon.png" />
		<link href="../css/map.css" rel="stylesheet" type="text/css" media="all" />
		<link href="../css/ui.css" rel="stylesheet" type="text/css" media="all" />
		<style type="text/css">
			.bubble {
				background: #fff;
				background: rgba(255,255,255,0.9);
				border: solid 2px #a00;
				border: solid 2px rgba(220,0,0,0.6);
				width: 100px;
				padding: 5px;
				text-align: center;
				border-radius: 10px;
				-webkit-border-radius: 10px;
			}
			#bubbles {
				position: absolute;
				top:0;
				left:0;
			}
		</style>
		<script src="../js/map.js" type="text/javascript"></script>
		<script type="text/javascript">
			document.addEventListener('DOMContentLoaded', function(){
				var map =  slippymap("map", true, 14, 13.379, 52.515).init();
				var markers = [];

				var lastRefresh = 0;
				function featureInfo(e){
					console.log("info");
					if (!event) {
						event = window.event;
					}
					function tile2lon(x, z) {
						return (x / Math.pow(2, z) * 360 - 180);
					};
					function tile2lat(y, z) {
						var n = Math.PI - 2 * Math.PI * y / Math.pow(2, z);
						return (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))));
					}
					function toRad(deg) {
 						return deg * Math.PI/180;
					}
					function distance(a,b){
						var R = 6371; // km
						var dLat = toRad(b[1]-a[1]);
						var dLon = toRad(b[0]-a[0]); 
						var angle = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(b[0])) * Math.cos(toRad(b[1])) * Math.sin(dLon/2) * Math.sin(dLon/2); 
						var c = 2 * Math.atan2(Math.sqrt(angle), Math.sqrt(1-angle)); 
						var d = R * c;	
						return d;
					}
					var metersPerPixel = [156412,78206,39103,19551,9776,4888,2444,1222 ,611,305,153,76,38,19,10,5,2,1,0.6];
					var center = map.center();
					var zp = Math.pow(2, map.maxZ() - center.z);
					var x = center.x + (event.clientX - e.target.offsetLeft - e.target.width/2)*zp;
					var y = center.y + (event.clientY - e.target.offsetTop - e.target.height/2)*zp;
					var lon = tile2lon(x / map.tileSize(), map.maxZ());
					var lat = tile2lat(y / map.tileSize(), map.maxZ());
					for(m in markers){
						var marker = markers[m];
						var dist = distance([marker.lon, marker.lat],[lon, lat]);
						if(dist<10*metersPerPixel[center.z-1]/1000){
							clearBubbles()
							infoWindow( marker.html || m, event.clientX - e.target.offsetLeft, event.clientY - e.target.offsetTop);
							break;
						}
					}
					
					
				}
				function infoWindow(text, x, y) {
					var bubble = document.createElement("div");
					bubble.innerHTML = text;
					bubble.setAttribute("class", "bubble");
					bubble.style.position = 'absolute';
					bubble.style.top = (y-10)+'px';
					bubble.style.left = (x-50)+'px';
					bubble.onclick = function(){
						this.style.display = "none";
					}
					document.getElementById("bubbles").appendChild(bubble);
				}
				function clearBubbles(){
					document.getElementById("bubbles").innerHTML = '';
				}
				function refresh(){
					var now = (new Date()).getTime();
					if(lastRefresh > now-1000) return;
					lastRefresh = now;
					update();
				}
				function update(){
					var dataRequest, xapi_query, bbox, radius, limit;
					coords = map.coords();
					radius = 0.5;

					bbox = [coords.lon-radius/2, coords.lat-radius/2, coords.lon+radius/2, coords.lat+radius/2];

					xapi_query = 'http://www.informationfreeway.org/api/0.6/node[amenity=arts_centre][bbox='+bbox;
					/* send xhr request */
					dataRequest = new XMLHttpRequest();
					dataRequest.onreadystatechange = mark;
					dataRequest.open('GET', xapi_query, true);
					dataRequest.send();
				}

				/* process results */
				function mark(){
					if (this.readyState == 4 && this.status == 200) {
						var xml = this.responseXML;
						var marker;
						if(true){
							var nodes = xml.getElementsByTagName("node") || [];
							for(var i=0; i<nodes.length; i++){
								var marker = {};
								var node = nodes[i];
								marker.src = "../images/arts_centre.png";
								marker.lat = parseFloat(node.getAttribute("lat"));
								marker.lon = parseFloat(node.getAttribute("lon"));
								marker.offsetX = -8;
								marker.offsetY = -8;
								var tags = node.getElementsByTagName("tag");
								for(var tag in tags){
									if(typeof tags[tag] === 'object' && tags[tag].getAttribute("k")==="name"){
										marker.html = tags[tag].getAttribute("v");
									}
								}
								markers.push(marker);
							}
						}
						map.setMarkers(markers);
					}
				}
				update();
				document.querySelectorAll("#map")[0].addEventListener('mouseup', refresh);
				map.fractionalZoom(false);
				document.querySelectorAll("#buttons .zoomin")[0].addEventListener('click', map.zoomIn);
				document.querySelectorAll("#buttons .zoomout")[0].addEventListener('click', map.zoomOut);
				document.querySelectorAll("#map")[0].addEventListener('mousedown', featureInfo);

				map.addMovedListeners(clearBubbles);
				map.addZoomedListeners(clearBubbles);
			});
		</script>	
	</head>
	<body>
		<canvas id="map">
			Your  browser doesn't support canvas elements.			
		</canvas>
		<div id="bubbles"></div>
		<ul id="buttons">
			<li><a class="zoomin">+</a></li>
			<li><a class="zoomout">-</a></li>
		</ul>
	</body>
</html>