<!DOCTYPE html>
<html manifest="map.manifest">
	<head>
		<meta charset="utf-8">
		<title>Slippy Map on Canvas (HTML5) | simple path example</title>
		<!--
		
		
			does not work with fractional zoom - yet
		
		
		-->
		<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<link rel="apple-touch-icon-precomposed" href="../images/touch-icon.png" />
		<link href="../css/map.css" rel="stylesheet" type="text/css" media="all" />
		<link href="../css/ui.css" rel="stylesheet" type="text/css" media="all" />
		<style type="text/css">
			.bubble {
				background: #fff;
				background: rgba(255,255,255,0.9);
				border: solid 2px #a00;
				border: solid 2px rgba(220,0,0,0.6);
				width: 100px;
				height: 20px;
				padding: 5px;
				text-align: center;
				border-radius: 10px;
				-webkit-border-radius: 10px;
			}
			#bubbles {
				position: absolute;
				top:0;
				left:0;
			}
		</style>
		<script src="../js/map.js" type="text/javascript"></script>
		<script type="text/javascript">
				function featureInfo(e){
					if (!event) {
						event = $.event;
					}
					function toRad(deg) {
 						return deg * Math.PI/180;
					}
					function distance(a,b){
						var R = 6371; // km
						var dLat = toRad(b[1]-a[1]);
						var dLon = toRad(b[0]-a[0]); 
						var angle = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(b[0])) * Math.cos(toRad(b[1])) * Math.sin(dLon/2) * Math.sin(dLon/2); 
						var c = 2 * Math.atan2(Math.sqrt(angle), Math.sqrt(1-angle)); 
						var d = R * c;	
						return d;
					}
					var metersPerPixel = [156412,78206,39103,19551,9776,4888,2444,1222 ,611,305,153,76,38,19,10,5,2,1,0.6];
					var zp = Math.pow(2, app.renderer.maxZ - app.pos.z);
					var x = app.pos.x + (event.clientX - app.renderer.canvas.offsetLeft - app.renderer.canvas.width/2)*zp;
					var y = app.pos.y + (event.clientY - app.renderer.canvas.offsetTop - app.renderer.canvas.height/2)*zp;
					var lon = app.pos.tile2lon(x / app.renderer.tilesize, app.renderer.maxZ);
					var lat = app.pos.tile2lat(y / app.renderer.tilesize, app.renderer.maxZ);

					for(m in app.markers){
						var marker = app.markers[m];
						var dist = distance([marker.lon, marker.lat],[lon, lat]);
						if(dist<10*metersPerPixel[app.pos.z-1]/1000){
							infoWindow( marker.html || m, event.clientX - app.renderer.canvas.offsetLeft, event.clientY - app.renderer.canvas.offsetTop);
							break;
						}
					}
					
					
				}
				function infoWindow(text, x, y) {
					var bubble = document.createElement("div");
					bubble.innerHTML = text;
					bubble.setAttribute("class", "bubble");
					bubble.style.position = 'absolute';
					bubble.style.top = (y-10)+'px';
					bubble.style.left = (x-50)+'px';
					bubble.onclick = function(){
						this.style.display = "none";
					}
					document.getElementById("bubbles").appendChild(bubble);
				}
				function clearBubbles(){
					document.getElementById("bubbles").innerHTML = '';
				}
				app.preInitListeners.push(function(){
					app.markers =    
						{	'Berlin' : 
							{	src : "../images/marker.png",
								lon : 13.409500,
								lat : 52.522488,
								offsetX : -11,
								offsetY : -25,
								html : '<a href="http://berlin.de">Berlin</a>'
							},
							'Moskva' : 
							{	src : "../images/marker.png",
								lon : 37.617633,
								lat : 55.755786,
								offsetX : -11,
								offsetY : -25
							},
							'Hong Kong' : 
							{	src : "../images/marker.png",
								lon : 114.10494,
								lat : 22.381111,
								offsetX : -11,
								offsetY : -25
							}
						}
				});
				app.postInitListeners.push(function(){
					app.renderer.canvas.addEventListener('mousedown', featureInfo, false);
					app.zoomedListeners.push(clearBubbles);
					app.movedListeners.push(clearBubbles);
				});
		</script>

	</head>
	<body>
		<canvas id="map">
			Your  browser doesn't support canvas elements.			
		</canvas>
		<ul id="buttons">
			<li><a class="zoomin" href="javascript:;" onclick="app.zoomIn(); return false;">+</a></li>
			<li><a class="zoomout" href="javascript:;" onclick="app.zoomOut(); return false;">-</a></li>
		</ul>
		<div id="bubbles"></div>
	</body>
</html>

